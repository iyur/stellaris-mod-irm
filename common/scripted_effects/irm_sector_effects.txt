# This = Country
# Make a dummy country to hold sector entities
irm_sector_make_dummy = {
	create_country = {
		name = root
		type = irm_country_sector
		auto_delete = no
		ignore_initial_colony_error = yes
		day_zero_contact = no
		contact_rule = on_action_only
		species = root.owner_species
		civics = root
		ethos = root
		flag = root
	}
	last_created_country = {
		set_name = {
			key = irm.ui.sector.country
			variable_string = "\\[Root.GetName]"
		}
		set_country_flag = irm_country_sector_@root
		copy_flags_and_variables_from = root
		copy_ethos_and_authority = root
		set_faction_hostility = { target = root set_hostile = no set_neutral = no set_friendly = yes }
		log = "created sectors dummy for \\[Prev.GetName] empire"
	}
}

# This = Sector
# Prev = Country
# Creates constructor for the given sector
irm_sector_make_constructor = {
	prev = {
		# get modifiers for construction cost
		export_modifier_to_variable = {
			modifier = shipclass_constructor_build_cost_mult
			variable = irm_constructor_cost
		}
		change_variable = { which = irm_constructor_cost value = 1 }
		multiply_variable = { which = irm_constructor_cost value = 100 }
		if = {
			limit = { has_resource = { type = alloys amount < irm_constructor_cost } }
			log = "not enough resources for \\[Prev.GetName]"
		}
		else = {
			add_resource = { alloys = -1 mult = irm_constructor_cost }
			create_fleet = {
				effect = {
					set_owner = prev
					set_location = prevprev.sector_capital
					set_fleet_flag = irm_sector_constructor_@prevprev
					set_name = {
						key = irm.ui.sector.constructor
						variable_string = "\\[PrevPrev.GetName]"
					}

					create_ship = {
						name = random
						random_existing_design = constructor
					}

					random_country = {
						limit = {
							is_country_type = irm_country_sector
							has_country_flag = irm_country_sector_@prevprev
						}
						prev = { set_owner = prev }
					}

				}
			}
			log = "constructor built for \\[Prev.GetName]"
		}
		irm_unset = { which = irm_constructor_cost }
	}
}

# This = Sector
# Prev = Country (Player)
# Check if sector can expand and send constructor here
irm_sector_try_expand = {
	owner = {
		export_modifier_to_variable = {
			modifier = starbase_outpost_cost_mult
			variable = irm_outpost_cost
		}
		change_variable = { which = irm_outpost_cost value = 1 }
		set_variable = { which = irm_outpost_cost_alloys value = irm_outpost_cost }
		set_variable = { which = irm_outpost_cost_influence value = irm_outpost_cost }
		multiply_variable = { which = irm_outpost_cost_alloys value = 100 }
		multiply_variable = { which = irm_outpost_cost_influence value = 75 }
	}
	if = {
		limit = {
			not = {
				any_country = {
					is_country_type = irm_country_sector
					has_country_flag = irm_country_sector_@prev.owner
					any_owned_fleet = {
						has_fleet_flag = irm_sector_constructor_@prevprev
					}
				}
			}
		}
		irm_sector_make_constructor = yes
	}
	else_if = {
		limit = {
			owner = {
				or = {
					has_resource = { type = alloys amount < irm_outpost_cost_alloys }
					has_resource = { type = alloys amount < irm_outpost_cost_influence }
				}
			}
		}
		log = "\\[Prev.GetName] has no resources for outpost"
	}
	else = {
		# pick the system from where we could expand
		random_system_within_border = {
			limit = {
				not = { irm_system_is_sector_max_extent = yes }
				any_neighbor_system = { irm_system_can_expand = yes }
			}
			random_neighbor_system = {
				limit = { irm_system_can_expand = yes }
				if = {
					limit = { exists = this }
					prevprev = {
						save_event_target_as = irm_sector_expanding
						owner = {
							add_resource = { alloys = -1 mult = irm_outpost_cost_alloys }
							add_resource = { influence = -1 mult = irm_outpost_cost_influence }
						}
					}
					# system_event = { id = irm_sector.31 days = 1 random = 5 scopes = { from = prev } }
					random_country = {
						limit = {
							is_country_type = irm_country_sector
							has_country_flag = irm_country_sector_@prevprev.owner
						}
						random_owned_fleet = {
							limit = {
								has_fleet_flag = irm_sector_constructor_@prevprevprev.sector
								is_fleet_idle = yes
							}
							irm_fleet_build_outpost = { target = prevprev }
						}
					}
					log = "constructor sent to \\[This.GetName] for expansion"
				}
			}
		}
	}
	owner = {
		irm_unset = { which = irm_outpost_cost }
		irm_unset = { which = irm_outpost_cost_alloys }
		irm_unset = { which = irm_outpost_cost_influence }
	}
}