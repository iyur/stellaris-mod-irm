# IRM: Imperial Routine Mod
# Author: Iyur
# Sector fleet actions & effects

# Simulate outpost construction in the given system
irm_fleet_build_outpost = {
	queue_actions = {
		move_to = $target$
		find_closest_planet = {
			trigger = {
				id = irm.fleet.build.outpost.1.t
				is_star = yes
			}
			found_planet = {
				orbit_planet = this
				wait = { duration = 29 }
				effect = {
					id = irm.fleet.build.outpost.1.e
					if = {
						limit = {
							any_fleet_in_orbit = {
								not = { is_same_value = prevprev }
								is_ship_class = shipclass_constructor
								# has_fleet_order = build_orbital_station_order
							}
						}
						log = "cannot build in \\[Prev.System.GetName]"
					}
					else = {
						prev = { irm_create_outpost = yes }
					}
				}
			}
		}
	}
}

# This = Fleet
irm_create_outpost = {
	solar_system = {
		create_starbase = {
			size = starbase_outpost
			owner = event_target:irm_sector_expanding.owner
		}
	}
	event_target:irm_sector_expanding.owner = {
		create_message = {
			type = STARBASE_CONSTRUCTION_MESSAGE_TYPE
			localization = "irm_message_sector_expanded_desc"
			days = 30
			target = prev.solar_system
			variable = {
				type = name
				localization = SECTOR
				scope = event_target:irm_sector_expanding
			}
			variable = {
				type = name
				localization = SYSTEM
				scope = prev.solar_system
			}
		}
	}
}

# Move ahead to a new colony
irm_fleet_colonize = {
	queue_actions = {
		move_to = $target$
		orbit_planet = $target$
		wait = 5
		effect = {
			id = irm.fleet.colonize.1.e
			if = {
				limit = {
					orbit = {
						or = {
							has_owner = yes
							is_colony = yes
						}
					}
				}
				log = "cannot colonize \\[PrevPrev.GetName]"
				clear_fleet_actions = this
				queue_actions = {
					move_to = prevprevprevprev.sector_capital
				}
			}
			else = {
				orbit = {
					prev = {
						random_controlled_ship = {
							species = {
								prevprevprev = {
									start_colony = {
										species = prev
									}
								}
							}
						}
					}
					log = "colonization of \\[This.GetName] has been started"
				}
				delete_fleet = this
			}
		}
	}
}